<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>関数電卓</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        body {
            font-family: 'Roboto Mono', monospace;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-2xl">
        <h1 class="text-white text-3xl font-bold text-center mb-4">関数電卓</h1>
        <div class="bg-gray-800 rounded-3xl shadow-2xl p-6 border border-gray-700">
            <div class="mb-6">
                <div class="bg-gray-900 rounded-2xl p-6 mb-4 border border-gray-700">
                    <div id="expression" class="text-gray-400 text-right text-sm min-h-6 mb-2 font-mono"></div>
                    <div id="display" class="text-white text-right text-4xl font-bold min-h-12 break-words font-mono">0</div>
                </div>
            </div>

            <!-- 科学関数ボタン -->
            <div class="grid grid-cols-5 gap-2 mb-3">
                <button onclick="appendFunction('sin(')" class="btn-function">sin</button>
                <button onclick="appendFunction('cos(')" class="btn-function">cos</button>
                <button onclick="appendFunction('tan(')" class="btn-function">tan</button>
                <button onclick="appendFunction('log(')" class="btn-function">log</button>
                <button onclick="appendFunction('ln(')" class="btn-function">ln</button>
            </div>

            <div class="grid grid-cols-5 gap-2 mb-3">
                <button onclick="appendFunction('asin(')" class="btn-function">asin</button>
                <button onclick="appendFunction('acos(')" class="btn-function">acos</button>
                <button onclick="appendFunction('atan(')" class="btn-function">atan</button>
                <button onclick="appendFunction('sqrt(')" class="btn-function">√</button>
                <button onclick="appendOperator('^')" class="btn-function">x^y</button>
            </div>

            <!-- メイン電卓ボタン -->
            <div class="grid grid-cols-5 gap-3">
                <button onclick="clearAll()" class="btn bg-red-600 hover:bg-red-700 col-span-2">AC</button>
                <button onclick="deleteLast()" class="btn bg-gray-600 hover:bg-gray-700">DEL</button>
                <button onclick="appendOperator('(')" class="btn bg-blue-600 hover:bg-blue-700">(</button>
                <button onclick="appendOperator(')')" class="btn bg-blue-600 hover:bg-blue-700">)</button>

                <button onclick="appendNumber('7')" class="btn bg-gray-700 hover:bg-gray-600">7</button>
                <button onclick="appendNumber('8')" class="btn bg-gray-700 hover:bg-gray-600">8</button>
                <button onclick="appendNumber('9')" class="btn bg-gray-700 hover:bg-gray-600">9</button>
                <button onclick="appendOperator('/')" class="btn bg-orange-600 hover:bg-orange-700">÷</button>
                <button onclick="appendConstant('π')" class="btn bg-purple-600 hover:bg-purple-700">π</button>

                <button onclick="appendNumber('4')" class="btn bg-gray-700 hover:bg-gray-600">4</button>
                <button onclick="appendNumber('5')" class="btn bg-gray-700 hover:bg-gray-600">5</button>
                <button onclick="appendNumber('6')" class="btn bg-gray-700 hover:bg-gray-600">6</button>
                <button onclick="appendOperator('*')" class="btn bg-orange-600 hover:bg-orange-700">×</button>
                <button onclick="appendConstant('e')" class="btn bg-purple-600 hover:bg-purple-700">e</button>

                <button onclick="appendNumber('1')" class="btn bg-gray-700 hover:bg-gray-600">1</button>
                <button onclick="appendNumber('2')" class="btn bg-gray-700 hover:bg-gray-600">2</button>
                <button onclick="appendNumber('3')" class="btn bg-gray-700 hover:bg-gray-600">3</button>
                <button onclick="appendOperator('-')" class="btn bg-orange-600 hover:bg-orange-700">-</button>
                <button onclick="calculate()" class="btn bg-green-600 hover:bg-green-700 row-span-2">=</button>

                <button onclick="appendNumber('0')" class="btn bg-gray-700 hover:bg-gray-600 col-span-2">0</button>
                <button onclick="appendNumber('.')" class="btn bg-gray-700 hover:bg-gray-600">.</button>
                <button onclick="appendOperator('+')" class="btn bg-orange-600 hover:bg-orange-700">+</button>
            </div>
        </div>
        <div class="text-center text-gray-400 text-sm mt-4">
            <p>三角関数(ラジアン) | log=常用対数 | ln=自然対数</p>
        </div>
    </div>

    <style>
        .btn {
            @apply rounded-xl text-white text-xl font-semibold py-4 transition-all duration-200 active:scale-95 shadow-lg;
        }
        .btn-function {
            @apply rounded-lg text-white text-sm font-semibold py-3 bg-indigo-600 hover:bg-indigo-700 transition-all duration-200 active:scale-95 shadow-lg;
        }
    </style>

    <script>
        let currentInput = '';

        function updateDisplay() {
            const display = document.getElementById('display');
            const expressionDiv = document.getElementById('expression');
            display.textContent = currentInput || '0';
        }

        function appendNumber(num) {
            if (currentInput === '0' && num !== '.') {
                currentInput = num;
            } else if (num === '.' && currentInput.includes('.') && !currentInput.includes('(')) {
                return;
            } else {
                currentInput += num;
            }
            updateDisplay();
        }

        function appendOperator(op) {
            if (currentInput && currentInput !== '0') {
                currentInput += op;
            } else if (op === '(' || op === ')') {
                currentInput += op;
            }
            updateDisplay();
        }

        function appendFunction(func) {
            if (currentInput === '0') {
                currentInput = func;
            } else {
                currentInput += func;
            }
            updateDisplay();
        }

        function appendConstant(constant) {
            if (currentInput === '0') {
                currentInput = constant;
            } else {
                currentInput += constant;
            }
            updateDisplay();
        }

        function clearAll() {
            currentInput = '';
            updateDisplay();
        }

        function deleteLast() {
            if (currentInput) {
                currentInput = currentInput.slice(0, -1);
            }
            updateDisplay();
        }

        async function calculate() {
            if (!currentInput || currentInput === '0') return;

            const expression = currentInput;
            document.getElementById('expression').textContent = expression;

            try {
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ expression: expression })
                });

                const data = await response.json();

                if (response.ok) {
                    currentInput = data.result.toString();
                    updateDisplay();
                    setTimeout(() => {
                        document.getElementById('expression').textContent = '';
                    }, 3000);
                } else {
                    document.getElementById('expression').textContent = 'エラー: ' + (data.error || '計算エラー');
                    setTimeout(() => {
                        document.getElementById('expression').textContent = '';
                    }, 3000);
                }
            } catch (error) {
                document.getElementById('expression').textContent = 'サーバーエラー';
                setTimeout(() => {
                    document.getElementById('expression').textContent = '';
                }, 3000);
            }
        }

        // キーボードサポート
        document.addEventListener('keydown', (e) => {
            if (e.key >= '0' && e.key <= '9' || e.key === '.') {
                appendNumber(e.key);
            } else if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') {
                appendOperator(e.key);
            } else if (e.key === 'Enter' || e.key === '=') {
                e.preventDefault();
                calculate();
            } else if (e.key === 'Escape') {
                clearAll();
            } else if (e.key === 'Backspace') {
                e.preventDefault();
                deleteLast();
            } else if (e.key === '(') {
                appendOperator('(');
            } else if (e.key === ')') {
                appendOperator(')');
            } else if (e.key === '^') {
                appendOperator('^');
            }
        });

        updateDisplay();
    </script>
</body>
</html>
