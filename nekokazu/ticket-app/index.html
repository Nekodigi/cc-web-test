<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRチケット</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">🎫 QRチケット</h1>

        <!-- チケット作成フォーム -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">新しいチケットを作成</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">チケット名</label>
                    <input type="text" id="ticketName"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="例: イベント入場券">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">説明（任意）</label>
                    <textarea id="ticketDescription"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              rows="3"
                              placeholder="チケットの詳細説明"></textarea>
                </div>
                <button onclick="createTicket()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    チケット作成
                </button>
            </div>
        </div>

        <!-- 作成されたチケット表示 -->
        <div id="createdTicket" class="hidden bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-green-600">✓ チケットが作成されました</h2>
            <div class="text-center">
                <img id="qrImage" src="" alt="QRコード" class="mx-auto mb-4 border-4 border-gray-200 rounded-lg">
                <p class="text-lg font-semibold mb-2" id="createdTicketName"></p>
                <p class="text-gray-600 mb-4" id="createdTicketDescription"></p>
                <div class="space-y-2">
                    <button onclick="downloadQR()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        QRコードをダウンロード
                    </button>
                    <button onclick="shareTicket()"
                            class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        共有
                    </button>
                    <button onclick="resetForm()"
                            class="w-full bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        別のチケットを作成
                    </button>
                </div>
            </div>
        </div>

        <!-- チケット検証セクション -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">チケット検証</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">チケットID</label>
                    <input type="text" id="verifyTicketId"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="チケットIDを入力">
                </div>
                <div class="flex space-x-2">
                    <button onclick="verifyTicket()"
                            class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        チケット確認
                    </button>
                    <button onclick="useTicket()"
                            class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        チケット使用
                    </button>
                </div>
            </div>
            <div id="verifyResult" class="mt-4 hidden"></div>
        </div>

        <!-- チケット一覧 -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">チケット一覧</h2>
                <button onclick="loadTickets()"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    更新
                </button>
            </div>
            <div id="ticketList" class="space-y-3">
                <p class="text-gray-500 text-center py-8">読み込み中...</p>
            </div>
        </div>
    </div>

    <script>
        let currentTicketId = null;

        // チケット作成
        async function createTicket() {
            const name = document.getElementById('ticketName').value.trim();
            if (!name) {
                alert('チケット名を入力してください');
                return;
            }

            const description = document.getElementById('ticketDescription').value.trim();

            try {
                const response = await fetch('/api/tickets/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });

                const result = await response.json();
                if (result.success) {
                    currentTicketId = result.ticket.id;
                    showCreatedTicket(result.ticket);
                } else {
                    alert('エラー: ' + result.error);
                }
            } catch (error) {
                alert('エラーが発生しました: ' + error.message);
            }
        }

        // 作成されたチケットを表示
        function showCreatedTicket(ticket) {
            document.getElementById('createdTicketName').textContent = ticket.name;
            document.getElementById('createdTicketDescription').textContent = ticket.description || '';
            document.getElementById('qrImage').src = `/api/tickets/${ticket.id}/qr`;
            document.getElementById('createdTicket').classList.remove('hidden');

            // フォームをスクロールアウト
            document.getElementById('createdTicket').scrollIntoView({ behavior: 'smooth' });
        }

        // QRコードダウンロード
        function downloadQR() {
            if (!currentTicketId) return;

            const link = document.createElement('a');
            link.href = `/api/tickets/${currentTicketId}/qr`;
            link.download = `ticket-${currentTicketId}.png`;
            link.click();
        }

        // チケット共有
        async function shareTicket() {
            if (!currentTicketId) return;

            const shareUrl = `${window.location.origin}/api/tickets/${currentTicketId}/verify`;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'QRチケット',
                        text: 'チケットを共有します',
                        url: shareUrl
                    });
                } catch (error) {
                    copyToClipboard(shareUrl);
                }
            } else {
                copyToClipboard(shareUrl);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('チケットURLをコピーしました');
            });
        }

        // フォームリセット
        function resetForm() {
            document.getElementById('ticketName').value = '';
            document.getElementById('ticketDescription').value = '';
            document.getElementById('createdTicket').classList.add('hidden');
            currentTicketId = null;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // チケット検証
        async function verifyTicket() {
            const ticketId = document.getElementById('verifyTicketId').value.trim();
            if (!ticketId) {
                alert('チケットIDを入力してください');
                return;
            }

            try {
                const response = await fetch(`/api/tickets/${ticketId}/verify`);
                const result = await response.json();

                const resultDiv = document.getElementById('verifyResult');
                resultDiv.classList.remove('hidden');

                if (result.success) {
                    const ticket = result.ticket;
                    const status = ticket.used ?
                        `<span class="text-red-600 font-semibold">使用済み</span>` :
                        `<span class="text-green-600 font-semibold">未使用</span>`;

                    resultDiv.innerHTML = `
                        <div class="border-2 ${ticket.used ? 'border-red-300 bg-red-50' : 'border-green-300 bg-green-50'} rounded-lg p-4">
                            <p class="font-semibold text-lg mb-2">${ticket.name}</p>
                            <p class="text-gray-600 mb-2">${ticket.description || ''}</p>
                            <p class="mb-1">ステータス: ${status}</p>
                            <p class="text-sm text-gray-600">作成日時: ${new Date(ticket.created_at).toLocaleString('ja-JP')}</p>
                            ${ticket.used_at ? `<p class="text-sm text-gray-600">使用日時: ${new Date(ticket.used_at).toLocaleString('ja-JP')}</p>` : ''}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="border-2 border-red-300 bg-red-50 rounded-lg p-4 text-red-600">${result.error}</div>`;
                }
            } catch (error) {
                alert('エラーが発生しました: ' + error.message);
            }
        }

        // チケット使用
        async function useTicket() {
            const ticketId = document.getElementById('verifyTicketId').value.trim();
            if (!ticketId) {
                alert('チケットIDを入力してください');
                return;
            }

            if (!confirm('このチケットを使用済みにしますか?')) {
                return;
            }

            try {
                const response = await fetch(`/api/tickets/${ticketId}/verify`, {
                    method: 'POST'
                });
                const result = await response.json();

                const resultDiv = document.getElementById('verifyResult');
                resultDiv.classList.remove('hidden');

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="border-2 border-green-300 bg-green-50 rounded-lg p-4 text-green-700">
                            <p class="font-semibold">✓ チケットを使用済みにしました</p>
                        </div>
                    `;
                    loadTickets();
                } else {
                    resultDiv.innerHTML = `<div class="border-2 border-red-300 bg-red-50 rounded-lg p-4 text-red-600">${result.error}</div>`;
                }
            } catch (error) {
                alert('エラーが発生しました: ' + error.message);
            }
        }

        // チケット一覧読み込み
        async function loadTickets() {
            try {
                const response = await fetch('/api/tickets');
                const result = await response.json();

                const listDiv = document.getElementById('ticketList');

                if (result.success && result.tickets.length > 0) {
                    listDiv.innerHTML = result.tickets.map(ticket => `
                        <div class="border ${ticket.used ? 'border-gray-300 bg-gray-50' : 'border-blue-300 bg-blue-50'} rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-semibold text-lg">${ticket.name}</p>
                                    <p class="text-sm text-gray-600 mb-2">${ticket.description || ''}</p>
                                    <p class="text-xs text-gray-500">ID: ${ticket.id}</p>
                                    <p class="text-xs text-gray-500">作成: ${new Date(ticket.created_at).toLocaleString('ja-JP')}</p>
                                    ${ticket.used_at ? `<p class="text-xs text-gray-500">使用: ${new Date(ticket.used_at).toLocaleString('ja-JP')}</p>` : ''}
                                </div>
                                <div class="ml-4 text-right">
                                    <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold ${ticket.used ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}">
                                        ${ticket.used ? '使用済み' : '未使用'}
                                    </span>
                                    ${!ticket.used ? `<button onclick="document.getElementById('verifyTicketId').value='${ticket.id}'; document.querySelector('.bg-purple-600').scrollIntoView({behavior: 'smooth'});" class="mt-2 text-sm text-blue-600 hover:text-blue-800">検証</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    listDiv.innerHTML = '<p class="text-gray-500 text-center py-8">チケットがありません</p>';
                }
            } catch (error) {
                document.getElementById('ticketList').innerHTML = '<p class="text-red-500 text-center py-8">読み込みエラー</p>';
            }
        }

        // 初期読み込み
        loadTickets();
    </script>
</body>
</html>
