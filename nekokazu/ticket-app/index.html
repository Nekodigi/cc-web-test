<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRãƒã‚±ãƒƒãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">ğŸ« QRãƒã‚±ãƒƒãƒˆ</h1>

        <!-- ãƒã‚±ãƒƒãƒˆä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">æ–°ã—ã„ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ãƒã‚±ãƒƒãƒˆå</label>
                    <input type="text" id="ticketName"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="ä¾‹: ã‚¤ãƒ™ãƒ³ãƒˆå…¥å ´åˆ¸">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
                    <textarea id="ticketDescription"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              rows="3"
                              placeholder="ãƒã‚±ãƒƒãƒˆã®è©³ç´°èª¬æ˜"></textarea>
                </div>
                <button onclick="createTicket()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    ãƒã‚±ãƒƒãƒˆä½œæˆ
                </button>
            </div>
        </div>

        <!-- ä½œæˆã•ã‚ŒãŸãƒã‚±ãƒƒãƒˆè¡¨ç¤º -->
        <div id="createdTicket" class="hidden bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-green-600">âœ“ ãƒã‚±ãƒƒãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ</h2>
            <div class="text-center">
                <img id="qrImage" src="" alt="QRã‚³ãƒ¼ãƒ‰" class="mx-auto mb-4 border-4 border-gray-200 rounded-lg">
                <p class="text-lg font-semibold mb-2" id="createdTicketName"></p>
                <p class="text-gray-600 mb-4" id="createdTicketDescription"></p>
                <div class="space-y-2">
                    <button onclick="downloadQR()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        QRã‚³ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                    <button onclick="shareTicket()"
                            class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        å…±æœ‰
                    </button>
                    <button onclick="resetForm()"
                            class="w-full bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        åˆ¥ã®ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- ãƒã‚±ãƒƒãƒˆæ¤œè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">ãƒã‚±ãƒƒãƒˆæ¤œè¨¼</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ãƒã‚±ãƒƒãƒˆID</label>
                    <input type="text" id="verifyTicketId"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="ãƒã‚±ãƒƒãƒˆIDã‚’å…¥åŠ›">
                </div>
                <div class="flex space-x-2">
                    <button onclick="verifyTicket()"
                            class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        ãƒã‚±ãƒƒãƒˆç¢ºèª
                    </button>
                    <button onclick="useTicket()"
                            class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        ãƒã‚±ãƒƒãƒˆä½¿ç”¨
                    </button>
                </div>
            </div>
            <div id="verifyResult" class="mt-4 hidden"></div>
        </div>

        <!-- ãƒã‚±ãƒƒãƒˆä¸€è¦§ -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">ãƒã‚±ãƒƒãƒˆä¸€è¦§</h2>
                <button onclick="loadTickets()"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    æ›´æ–°
                </button>
            </div>
            <div id="ticketList" class="space-y-3">
                <p class="text-gray-500 text-center py-8">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        let currentTicketId = null;

        // ãƒã‚±ãƒƒãƒˆä½œæˆ
        async function createTicket() {
            const name = document.getElementById('ticketName').value.trim();
            if (!name) {
                alert('ãƒã‚±ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const description = document.getElementById('ticketDescription').value.trim();

            try {
                const response = await fetch('/api/tickets/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });

                const result = await response.json();
                if (result.success) {
                    currentTicketId = result.ticket.id;
                    showCreatedTicket(result.ticket);
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ä½œæˆã•ã‚ŒãŸãƒã‚±ãƒƒãƒˆã‚’è¡¨ç¤º
        function showCreatedTicket(ticket) {
            document.getElementById('createdTicketName').textContent = ticket.name;
            document.getElementById('createdTicketDescription').textContent = ticket.description || '';
            document.getElementById('qrImage').src = `/api/tickets/${ticket.id}/qr`;
            document.getElementById('createdTicket').classList.remove('hidden');

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ
            document.getElementById('createdTicket').scrollIntoView({ behavior: 'smooth' });
        }

        // QRã‚³ãƒ¼ãƒ‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadQR() {
            if (!currentTicketId) return;

            const link = document.createElement('a');
            link.href = `/api/tickets/${currentTicketId}/qr`;
            link.download = `ticket-${currentTicketId}.png`;
            link.click();
        }

        // ãƒã‚±ãƒƒãƒˆå…±æœ‰
        async function shareTicket() {
            if (!currentTicketId) return;

            const shareUrl = `${window.location.origin}/api/tickets/${currentTicketId}/verify`;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'QRãƒã‚±ãƒƒãƒˆ',
                        text: 'ãƒã‚±ãƒƒãƒˆã‚’å…±æœ‰ã—ã¾ã™',
                        url: shareUrl
                    });
                } catch (error) {
                    copyToClipboard(shareUrl);
                }
            } else {
                copyToClipboard(shareUrl);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('ãƒã‚±ãƒƒãƒˆURLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            });
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetForm() {
            document.getElementById('ticketName').value = '';
            document.getElementById('ticketDescription').value = '';
            document.getElementById('createdTicket').classList.add('hidden');
            currentTicketId = null;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ãƒã‚±ãƒƒãƒˆæ¤œè¨¼
        async function verifyTicket() {
            const ticketId = document.getElementById('verifyTicketId').value.trim();
            if (!ticketId) {
                alert('ãƒã‚±ãƒƒãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const response = await fetch(`/api/tickets/${ticketId}/verify`);
                const result = await response.json();

                const resultDiv = document.getElementById('verifyResult');
                resultDiv.classList.remove('hidden');

                if (result.success) {
                    const ticket = result.ticket;
                    const status = ticket.used ?
                        `<span class="text-red-600 font-semibold">ä½¿ç”¨æ¸ˆã¿</span>` :
                        `<span class="text-green-600 font-semibold">æœªä½¿ç”¨</span>`;

                    resultDiv.innerHTML = `
                        <div class="border-2 ${ticket.used ? 'border-red-300 bg-red-50' : 'border-green-300 bg-green-50'} rounded-lg p-4">
                            <p class="font-semibold text-lg mb-2">${ticket.name}</p>
                            <p class="text-gray-600 mb-2">${ticket.description || ''}</p>
                            <p class="mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${status}</p>
                            <p class="text-sm text-gray-600">ä½œæˆæ—¥æ™‚: ${new Date(ticket.created_at).toLocaleString('ja-JP')}</p>
                            ${ticket.used_at ? `<p class="text-sm text-gray-600">ä½¿ç”¨æ—¥æ™‚: ${new Date(ticket.used_at).toLocaleString('ja-JP')}</p>` : ''}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="border-2 border-red-300 bg-red-50 rounded-lg p-4 text-red-600">${result.error}</div>`;
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒã‚±ãƒƒãƒˆä½¿ç”¨
        async function useTicket() {
            const ticketId = document.getElementById('verifyTicketId').value.trim();
            if (!ticketId) {
                alert('ãƒã‚±ãƒƒãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm('ã“ã®ãƒã‚±ãƒƒãƒˆã‚’ä½¿ç”¨æ¸ˆã¿ã«ã—ã¾ã™ã‹?')) {
                return;
            }

            try {
                const response = await fetch(`/api/tickets/${ticketId}/verify`, {
                    method: 'POST'
                });
                const result = await response.json();

                const resultDiv = document.getElementById('verifyResult');
                resultDiv.classList.remove('hidden');

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="border-2 border-green-300 bg-green-50 rounded-lg p-4 text-green-700">
                            <p class="font-semibold">âœ“ ãƒã‚±ãƒƒãƒˆã‚’ä½¿ç”¨æ¸ˆã¿ã«ã—ã¾ã—ãŸ</p>
                        </div>
                    `;
                    loadTickets();
                } else {
                    resultDiv.innerHTML = `<div class="border-2 border-red-300 bg-red-50 rounded-lg p-4 text-red-600">${result.error}</div>`;
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒã‚±ãƒƒãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadTickets() {
            try {
                const response = await fetch('/api/tickets');
                const result = await response.json();

                const listDiv = document.getElementById('ticketList');

                if (result.success && result.tickets.length > 0) {
                    listDiv.innerHTML = result.tickets.map(ticket => `
                        <div class="border ${ticket.used ? 'border-gray-300 bg-gray-50' : 'border-blue-300 bg-blue-50'} rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-semibold text-lg">${ticket.name}</p>
                                    <p class="text-sm text-gray-600 mb-2">${ticket.description || ''}</p>
                                    <p class="text-xs text-gray-500">ID: ${ticket.id}</p>
                                    <p class="text-xs text-gray-500">ä½œæˆ: ${new Date(ticket.created_at).toLocaleString('ja-JP')}</p>
                                    ${ticket.used_at ? `<p class="text-xs text-gray-500">ä½¿ç”¨: ${new Date(ticket.used_at).toLocaleString('ja-JP')}</p>` : ''}
                                </div>
                                <div class="ml-4 text-right">
                                    <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold ${ticket.used ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}">
                                        ${ticket.used ? 'ä½¿ç”¨æ¸ˆã¿' : 'æœªä½¿ç”¨'}
                                    </span>
                                    ${!ticket.used ? `<button onclick="document.getElementById('verifyTicketId').value='${ticket.id}'; document.querySelector('.bg-purple-600').scrollIntoView({behavior: 'smooth'});" class="mt-2 text-sm text-blue-600 hover:text-blue-800">æ¤œè¨¼</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    listDiv.innerHTML = '<p class="text-gray-500 text-center py-8">ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
                }
            } catch (error) {
                document.getElementById('ticketList').innerHTML = '<p class="text-red-500 text-center py-8">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
            }
        }

        // åˆæœŸèª­ã¿è¾¼ã¿
        loadTickets();
    </script>
</body>
</html>
